generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model UserType {
  userTypeName String @unique
  userTypeDesc String
  User         User[]
  
  @@map("user_types")
}

model User {
  userId        Int          @id @unique @default(autoincrement())
  clerkId       String       @unique // Clerk user ID for sync
  email         String       @unique
  firstName     String?
  lastName      String?
  username      String?      @unique
  imageUrl      String?
  userTypeName  String       @default("user")
  bannedUntil   DateTime?    // Null means not banned, date means banned until that date
  totalPlayTime Int          @default(0)
  exp           Int          @default(0)
  pp            Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  PassResult    PassResult[]
  favorites     UserFavorites[]
  userType      UserType     @relation(fields: [userTypeName], references: [userTypeName])
}

// Remove Auth model as we'll use Clerk for authentication
// model Auth {
//   authId   Int    @id @unique @default(autoincrement())
//   userId   Int
//   email    String
//   password String
//   phone    String
//   userName String @unique
//   user     User   @relation(fields: [userId], references: [userId])
// }

model Song {
  songId        Int     @id @default(autoincrement())
  beatmapSetId  Int?    @unique // Made optional - can be NULL
  songUrl       String
  defaultImg    String
  title         String
  titleUnicode  String
  artist        String
  artistUnicode String
  active        Boolean @default(true)
  disabledOn    DateTime? // Null means not disabled, date means disabled timestamp
  levels        Level[]
}

model Level {
  levelId      Int          @id @default(autoincrement())
  songId       Int
  beatmapId    Int
  difficulty   Decimal      @db.Decimal(6,2) // Allow up to 9999.99 difficulty with 2 decimal places
  image        String
  approachRate Decimal
  noteData     Json[]
  breakData    Json[]
  beatmapUrl   String
  active       Boolean      @default(true)
  song         Song         @relation(fields: [songId], references: [songId], onDelete: Cascade)
  passResult   PassResult[]
  favoritedBy  UserFavorites[]

  @@unique([songId, beatmapId])
}

model PassResult {
  passResultId  Int   @id @unique @default(autoincrement())
  userId        Int
  levelId       Int
  timestamp     Int
  score         Int   @default(0)
  hits          Int   @default(0)
  misses        Int   @default(0)
  healthBarData Int   @default(0)
  replayData    Int
  level         Level @relation(fields: [levelId], references: [levelId])
  user          User  @relation(fields: [userId], references: [userId])
}

model UserFavorites {
  userId   Int
  levelId  Int
  favoritedAt DateTime @default(now())
  user     User  @relation(fields: [userId], references: [userId], onDelete: Cascade)
  level    Level @relation(fields: [levelId], references: [levelId], onDelete: Cascade)

  @@id([userId, levelId])
  @@map("user_favorites")
}